{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- 页面标题和操作按钮 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-chart-bar me-2"></i>{{ title }}</h2>
            <p class="text-muted">{{ statement.period }} - {{ statement.report_date|date:"Y年m月d日 H:i" }}生成</p>
        </div>
        <div>
            <a href="{% url 'finance_app:income_statement_list' %}" class="btn btn-outline-secondary me-2">
                <i class="fas fa-arrow-left me-1"></i>返回列表
            </a>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-warning dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="fas fa-download me-1"></i>导出
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#"><i class="fas fa-file-excel text-success me-2"></i>Excel格式</a></li>
                    <li><a class="dropdown-item" href="#"><i class="fas fa-file-pdf text-danger me-2"></i>PDF格式</a></li>
                    <li><a class="dropdown-item" href="#"><i class="fas fa-print text-primary me-2"></i>打印预览</a></li>
                </ul>
                {% if not statement.is_final %}
                <a href="#" class="btn btn-warning">
                    <i class="fas fa-edit me-1"></i>编辑
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- 盈利状态显示 -->
    {% if statement.net_profit > 0 %}
    <div class="alert alert-success mb-4">
        <div class="d-flex align-items-center">
            <i class="fas fa-trophy fa-2x me-3"></i>
            <div>
                <h5 class="alert-heading mb-1">本期盈利 ✓</h5>
                <p class="mb-0">
                    净利润为 ¥{{ statement.net_profit|floatformat:2 }}，利润率 
                    {% if statement.total_revenue > 0 %}
                        {{ statement.net_profit|div:statement.total_revenue|multiply:100|floatformat:1 }}%
                    {% else %}
                        0%
                    {% endif %}
                </p>
            </div>
            {% if not statement.is_final %}
            <div class="ms-auto">
                <button type="button" class="btn btn-success">标记为定稿</button>
            </div>
            {% endif %}
        </div>
    </div>
    {% elif statement.net_profit < 0 %}
    <div class="alert alert-danger mb-4">
        <div class="d-flex align-items-center">
            <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
            <div>
                <h5 class="alert-heading mb-1">本期亏损</h5>
                <p class="mb-0">
                    净利润为 ¥{{ statement.net_profit|floatformat:2 }}，亏损率 
                    {% if statement.total_revenue > 0 %}
                        {{ statement.net_profit|abs|div:statement.total_revenue|multiply:100|floatformat:1 }}%
                    {% else %}
                        0%
                    {% endif %}
                </p>
            </div>
            <div class="ms-auto">
                <button type="button" class="btn btn-outline-danger">分析原因</button>
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-warning mb-4">
        <div class="d-flex align-items-center">
            <i class="fas fa-balance-scale fa-2x me-3"></i>
            <div>
                <h5 class="alert-heading mb-1">收支平衡</h5>
                <p class="mb-0">本期净利润为 0，收入与费用完全相等</p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 利润表主要内容 -->
    <div class="row">
        <!-- 左侧：收入和成本 -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-money-bill-wave me-2"></i>利润表详情</h5>
                </div>
                <div class="card-body p-0">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th width="60%">项目</th>
                                <th class="text-end">金额</th>
                                <th class="text-end">占收入比</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 一、营业收入 -->
                            <tr class="table-info">
                                <td colspan="3" class="bg-light">
                                    <strong>一、营业收入</strong>
                                </td>
                            </tr>
                            <tr>
                                <td class="ps-4">
                                    营业收入
                                    <small class="text-muted d-block">主营业务产生的收入</small>
                                </td>
                                <td class="text-end">¥{{ statement.operating_revenue|floatformat:2 }}</td>
                                <td class="text-end">
                                    {% if statement.total_revenue > 0 %}
                                    <span class="badge bg-light text-dark">
                                        {{ statement.operating_revenue|div:statement.total_revenue|multiply:100|floatformat:1 }}%
                                    </span>
                                    {% else %}
                                    <span class="badge bg-light text-dark">0%</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td class="ps-4">
                                    其他收入
                                    <small class="text-muted d-block">非主营业务收入</small>
                                </td>
                                <td class="text-end">¥{{ statement.other_revenue|floatformat:2 }}</td>
                                <td class="text-end">
                                    {% if statement.total_revenue > 0 %}
                                    <span class="badge bg-light text-dark">
                                        {{ statement.other_revenue|div:statement.total_revenue|multiply:100|floatformat:1 }}%
                                    </span>
                                    {% else %}
                                    <span class="badge bg-light text-dark">0%</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr class="table-success">
                                <td><strong>收入合计</strong></td>
                                <td class="text-end"><strong>¥{{ statement.total_revenue|floatformat:2 }}</strong></td>
                                <td class="text-end"><strong>100%</strong></td>
                            </tr>

                            <!-- 二、营业成本 -->
                            <tr class="table-info">
                                <td colspan="3" class="bg-light">
                                    <strong>二、营业成本</strong>
                                </td>
                            </tr>
                            <tr>
                                <td class="ps-4">
                                    营业成本
                                    <small class="text-muted d-block">直接成本</small>
                                </td>
                                <td class="text-end text-danger">-¥{{ statement.operating_cost|floatformat:2 }}</td>
                                <td class="text-end">
                                    {% if statement.total_revenue > 0 %}
                                    <span class="badge bg-light text-dark">
                                        {{ statement.operating_cost|div:statement.total_revenue|multiply:100|floatformat:1 }}%
                                    </span>
                                    {% else %}
                                    <span class="badge bg-light text-dark">0%</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr class="table-success">
                                <td><strong>毛利润</strong></td>
                                <td class="text-end"><strong>
                                    {% if statement.gross_profit >= 0 %}
                                    <span class="text-success">¥{{ statement.gross_profit|floatformat:2 }}</span>
                                    {% else %}
                                    <span class="text-danger">¥{{ statement.gross_profit|floatformat:2 }}</span>
                                    {% endif %}
                                </strong></td>
                                <td class="text-end"><strong>
                                    {% if statement.total_revenue > 0 %}
                                    {{ statement.gross_profit|div:statement.total_revenue|multiply:100|floatformat:1 }}%
                                    {% else %}0%{% endif %}
                                </strong></td>
                            </tr>

                            <!-- 三、期间费用 -->
                            <tr class="table-info">
                                <td colspan="3" class="bg-light">
                                    <strong>三、期间费用</strong>
                                </td>
                            </tr>
                            <tr>
                                <td class="ps-4">
                                    销售费用
                                    <small class="text-muted d-block">市场推广、销售佣金等</small>
                                </td>
                                <td class="text-end text-danger">-¥{{ statement.selling_expenses|floatformat:2 }}</td>
                                <td class="text-end">
                                    {% if statement.total_revenue > 0 %}
                                    <span class="badge bg-light text-dark">
                                        {{ statement.selling_expenses|div:statement.total_revenue|multiply:100|floatformat:1 }}%
                                    </span>
                                    {% else %}
                                    <span class="badge bg-light text-dark">0%</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td class="ps-4">
                                    管理费用
                                    <small class="text-muted d-block">行政、管理人员薪酬等</small>
                                </td>
                                <td class="text-end text-danger">-¥{{ statement.admin_expenses|floatformat:2 }}</td>
                                <td class="text-end">
                                    {% if statement.total_revenue > 0 %}
                                    <span class="badge bg-light text-dark">
                                        {{ statement.admin_expenses|div:statement.total_revenue|multiply:100|floatformat:1 }}%
                                    </span>
                                    {% else %}
                                    <span class="badge bg-light text-dark">0%</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td class="ps-4">
                                    财务费用
                                    <small class="text-muted d-block">利息支出、汇兑损失等</small>
                                </td>
                                <td class="text-end text-danger">-¥{{ statement.financial_expenses|floatformat:2 }}</td>
                                <td class="text-end">
                                    {% if statement.total_revenue > 0 %}
                                    <span class="badge bg-light text-dark">
                                        {{ statement.financial_expenses|div:statement.total_revenue|multiply:100|floatformat:1 }}%
                                    </span>
                                    {% else %}
                                    <span class="badge bg-light text-dark">0%</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr class="table-success">
                                <td><strong>营业利润</strong></td>
                                <td class="text-end"><strong>
                                    {% if statement.operating_profit >= 0 %}
                                    <span class="text-success">¥{{ statement.operating_profit|floatformat:2 }}</span>
                                    {% else %}
                                    <span class="text-danger">¥{{ statement.operating_profit|floatformat:2 }}</span>
                                    {% endif %}
                                </strong></td>
                                <td class="text-end"><strong>
                                    {% if statement.total_revenue > 0 %}
                                    {{ statement.operating_profit|div:statement.total_revenue|multiply:100|floatformat:1 }}%
                                    {% else %}0%{% endif %}
                                </strong></td>
                            </tr>

                            <!-- 四、其他收支 -->
                            <tr class="table-info">
                                <td colspan="3" class="bg-light">
                                    <strong>四、其他收支</strong>
                                </td>
                            </tr>
                            <tr>
                                <td class="ps-4">
                                    其他收益
                                    <small class="text-muted d-block">投资收益、政府补助等</small>
                                </td>
                                <td class="text-end text-success">+¥{{ statement.other_income|floatformat:2 }}</td>
                                <td class="text-end">
                                    {% if statement.total_revenue > 0 %}
                                    <span class="badge bg-light text-dark">
                                        {{ statement.other_income|div:statement.total_revenue|multiply:100|floatformat:1 }}%
                                    </span>
                                    {% else %}
                                    <span class="badge bg-light text-dark">0%</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td class="ps-4">
                                    其他支出
                                    <small class="text-muted d-block">资产处置损失、捐赠支出等</small>
                                </td>
                                <td class="text-end text-danger">-¥{{ statement.other_expenses|floatformat:2 }}</td>
                                <td class="text-end">
                                    {% if statement.total_revenue > 0 %}
                                    <span class="badge bg-light text-dark">
                                        {{ statement.other_expenses|div:statement.total_revenue|multiply:100|floatformat:1 }}%
                                    </span>
                                    {% else %}
                                    <span class="badge bg-light text-dark">0%</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr class="table-success">
                                <td><strong>利润总额</strong></td>
                                <td class="text-end"><strong>
                                    {% if statement.profit_before_tax >= 0 %}
                                    <span class="text-success">¥{{ statement.profit_before_tax|floatformat:2 }}</span>
                                    {% else %}
                                    <span class="text-danger">¥{{ statement.profit_before_tax|floatformat:2 }}</span>
                                    {% endif %}
                                </strong></td>
                                <td class="text-end"><strong>
                                    {% if statement.total_revenue > 0 %}
                                    {{ statement.profit_before_tax|div:statement.total_revenue|multiply:100|floatformat:1 }}%
                                    {% else %}0%{% endif %}
                                </strong></td>
                            </tr>

                            <!-- 五、所得税 -->
                            <tr class="table-info">
                                <td colspan="3" class="bg-light">
                                    <strong>五、所得税</strong>
                                </td>
                            </tr>
                            <tr>
                                <td class="ps-4">
                                    所得税费用
                                    <small class="text-muted d-block">企业所得税</small>
                                </td>
                                <td class="text-end text-danger">-¥{{ statement.tax_expense|floatformat:2 }}</td>
                                <td class="text-end">
                                    {% if statement.total_revenue > 0 %}
                                    <span class="badge bg-light text-dark">
                                        {{ statement.tax_expense|div:statement.total_revenue|multiply:100|floatformat:1 }}%
                                    </span>
                                    {% else %}
                                    <span class="badge bg-light text-dark">0%</span>
                                    {% endif %}
                                </td>
                            </tr>

                            <!-- 六、净利润 -->
                            <tr class="table-warning">
                                <td><strong>六、净利润</strong></td>
                                <td class="text-end"><strong>
                                    {% if statement.net_profit >= 0 %}
                                    <span class="text-success">¥{{ statement.net_profit|floatformat:2 }}</span>
                                    {% else %}
                                    <span class="text-danger">¥{{ statement.net_profit|floatformat:2 }}</span>
                                    {% endif %}
                                </strong></td>
                                <td class="text-end"><strong>
                                    {% if statement.total_revenue > 0 %}
                                    {{ statement.net_profit|div:statement.total_revenue|multiply:100|floatformat:1 }}%
                                    {% else %}0%{% endif %}
                                </strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 右侧：图表和分析 -->
        <div class="col-md-4">
            <!-- 图表 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>成本结构分析</h5>
                </div>
                <div class="card-body">
                    <canvas id="costStructureChart" width="300" height="300"></canvas>
                </div>
            </div>

            <!-- 关键指标 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>关键指标</h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-8">毛利率：</dt>
                        <dd class="col-sm-4 text-end">
                            {% if statement.total_revenue > 0 %}
                            <span class="badge {% if statement.gross_profit|div:statement.total_revenue|multiply:100 >= 30 %}bg-success{% elif statement.gross_profit|div:statement.total_revenue|multiply:100 >= 20 %}bg-warning{% else %}bg-danger{% endif %}">
                                {{ statement.gross_profit|div:statement.total_revenue|multiply:100|floatformat:1 }}%
                            </span>
                            {% else %}0%{% endif %}
                        </dd>

                        <dt class="col-sm-8">营业利润率：</dt>
                        <dd class="col-sm-4 text-end">
                            {% if statement.total_revenue > 0 %}
                            <span class="badge {% if statement.operating_profit|div:statement.total_revenue|multiply:100 >= 15 %}bg-success{% elif statement.operating_profit|div:statement.total_revenue|multiply:100 >= 10 %}bg-warning{% else %}bg-danger{% endif %}">
                                {{ statement.operating_profit|div:statement.total_revenue|multiply:100|floatformat:1 }}%
                            </span>
                            {% else %}0%{% endif %}
                        </dd>

                        <dt class="col-sm-8">净利率：</dt>
                        <dd class="col-sm-4 text-end">
                            {% if statement.total_revenue > 0 %}
                            <span class="badge {% if statement.net_profit|div:statement.total_revenue|multiply:100 >= 10 %}bg-success{% elif statement.net_profit|div:statement.total_revenue|multiply:100 >= 5 %}bg-warning{% else %}bg-danger{% endif %}">
                                {{ statement.net_profit|div:statement.total_revenue|multiply:100|floatformat:1 }}%
                            </span>
                            {% else %}0%{% endif %}
                        </dd>

                        <dt class="col-sm-8">成本收入比：</dt>
                        <dd class="col-sm-4 text-end">
                            {% if statement.total_revenue > 0 %}
                            <span class="badge {% if statement.total_cost_expense|div:statement.total_revenue|multiply:100 <= 70 %}bg-success{% elif statement.total_cost_expense|div:statement.total_revenue|multiply:100 <= 80 %}bg-warning{% else %}bg-danger{% endif %}">
                                {{ statement.total_cost_expense|div:statement.total_revenue|multiply:100|floatformat:1 }}%
                            </span>
                            {% else %}0%{% endif %}
                        </dd>
                    </dl>
                </div>
            </div>

            <!-- 报表信息 -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>报表信息</h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-6">会计期间：</dt>
                        <dd class="col-sm-6">{{ statement.period }}</dd>
                        
                        <dt class="col-sm-6">生成时间：</dt>
                        <dd class="col-sm-6">{{ statement.report_date|date:"Y-m-d H:i" }}</dd>
                        
                        <dt class="col-sm-6">生成人：</dt>
                        <dd class="col-sm-6">{{ statement.generated_by.username }}</dd>
                        
                        <dt class="col-sm-6">状态：</dt>
                        <dd class="col-sm-6">
                            {% if statement.is_final %}
                            <span class="badge bg-success">已定稿</span>
                            {% else %}
                            <span class="badge bg-warning">草稿</span>
                            {% endif %}
                        </dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>

    <!-- 对比分析 -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-balance-scale me-2"></i>财务分析</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>盈利能力分析</h6>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    每元收入成本
                                    <span class="badge bg-light text-dark">
                                        {% if statement.total_revenue > 0 %}
                                        ¥{{ statement.total_cost_expense|div:statement.total_revenue|floatformat:2 }}
                                        {% else %}¥0.00{% endif %}
                                    </span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    每元收入利润
                                    <span class="badge bg-light text-dark">
                                        {% if statement.total_revenue > 0 %}
                                        ¥{{ statement.net_profit|div:statement.total_revenue|floatformat:2 }}
                                        {% else %}¥0.00{% endif %}
                                    </span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    费用收入比
                                    <span class="badge bg-light text-dark">
                                        {% if statement.total_revenue > 0 %}
                                        {{ statement.total_cost_expense|div:statement.total_revenue|multiply:100|floatformat:1 }}%
                                        {% else %}0%{% endif %}
                                    </span>
                                </li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>建议措施</h6>
                            <div class="alert alert-light">
                                <small>
                                    {% if statement.net_profit <= 0 %}
                                    <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                                    <strong>建议：</strong>加强成本控制，优化费用结构
                                    {% elif statement.net_profit|div:statement.total_revenue|multiply:100 < 5 %}
                                    <i class="fas fa-lightbulb text-warning me-2"></i>
                                    <strong>建议：</strong>提升毛利率，拓展高利润业务
                                    {% else %}
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <strong>良好：</strong>保持当前盈利水平，关注可持续性
                                    {% endif %}
                                </small>
                            </div>
                            <div class="d-grid gap-2">
                                <a href="{% url 'finance_app:balance_sheet_detail' period=statement.period %}" 
                                   class="btn btn-outline-success btn-sm">
                                    <i class="fas fa-balance-scale me-2"></i>查看同期资产负债表
                                </a>
                                <button type="button" class="btn btn-outline-info btn-sm">
                                    <i class="fas fa-chart-line me-2"></i>趋势对比分析
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<!-- 引入 Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
$(document).ready(function() {
    // 成本结构饼图
    const ctx = document.getElementById('costStructureChart').getContext('2d');
    const costStructureChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['营业成本', '销售费用', '管理费用', '财务费用', '所得税', '净利润'],
            datasets: [{
                data: [
                    {{ statement.operating_cost|default:0 }},
                    {{ statement.selling_expenses|default:0 }},
                    {{ statement.admin_expenses|default:0 }},
                    {{ statement.financial_expenses|default:0 }},
                    {{ statement.tax_expense|default:0 }},
                    {{ statement.net_profit|default:0 }}
                ],
                backgroundColor: [
                    '#dc3545', // 红 - 营业成本
                    '#fd7e14', // 橙 - 销售费用
                    '#ffc107', // 黄 - 管理费用
                    '#6c757d', // 灰 - 财务费用
                    '#17a2b8', // 青 - 所得税
                    '{{ statement.net_profit >= 0 ? "#28a745" : "#dc3545" }}' // 绿/红 - 净利润
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            if (label) {
                                label += ': ';
                            }
                            const value = context.raw;
                            const total = {{ statement.total_revenue|default:0 }};
                            const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                            label += '¥' + value.toLocaleString() + ' (' + percentage + '%)';
                            return label;
                        }
                    }
                }
            }
        }
    });
    
    // 打印功能
    $('.btn-print').click(function() {
        window.print();
    });
});
</script>
{% endblock %}
{% endblock %}